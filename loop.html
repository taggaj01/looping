<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Coaster Loader</title>

<style>
  :root {
    --loader-size: 160px;
    --red-size: 73px;
    --blue-size: 55px;
    --car-size: 6px;
    --duration: 1200;
    --spacing: 0.5;
    --main: #b78482;
  }

  body {
    margin: 0;
    height: 100vh;
    display: grid;
    place-items: center;
    background: #f0f0f0;
  }

  .themepark-loader {
    position: relative;
    width: var(--loader-size);
    height: var(--loader-size);
  }

  .loop {
    position: absolute;
    border-radius: 50%;
    border: 4px solid;
  }

  .loop-red {
    /* border-color: #ff4136; */
    border-color: var(--main);
    width: var(--red-size);
    height: var(--red-size);
    top: 34px;
    left: 48px;
  }

  .loop-blue {
    /* border-color: #0074d9; */
    border-color: var(--main);
    width: var(--blue-size);
    height: var(--blue-size);
    top: 54px;
    left: 31px;
  }

  .car {
    position: absolute;
    width: var(--car-size);
    height: var(--car-size);
    background: var(--main);
    border-radius: 50%;
    /* border: 2px solid #fff; */
    box-shadow: 0 0 8px #0006;
    transform: translate(-50%, -50%);
  }

  .entrance {
    position: absolute;
    height: 78px;
    left: 50%;
    bottom: 0;
    transform: translateX(-50%);
    width: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 1;
  }

  .entrance-roof {
    width: 100%;
    height: 18px;
    background: repeating-linear-gradient(
      90deg,
      var(--main) 0 13px,
      var(--main) 13px 26px
    );
    clip-path: polygon(
      0 100%, 10% 30%, 20% 100%, 30% 30%, 40% 100%, 
      50% 30%, 60% 100%, 70% 30%, 80% 100%, 
      90% 30%, 100% 100%, 0 100%
    );
    border-bottom: 2px solid #a59d95;
  }

  .entrance-body {
    width: 70px;
    height: 20px;
    /* background: #ffe066; */
    background: var(--main);
    border: 2px solid #a59d95;
    border-radius: 0 0 8px 8px;
    position: relative;
  }

  .entrance-door {
    position: absolute;
    width: 16px;
    height: 14px;
    background: #ffffffbd;
    border: 2px solid #a59d95;
    border-radius: 0 0 6px 6px;
    left: 50%;
    bottom: 0;
    transform: translateX(-50%);
  }
</style>
</head>

<body>

<div class="themepark-loader">
  <div class="loop loop-red"></div>
  <div class="loop loop-blue"></div>

  <div class="car"></div>
  <div class="car"></div>
  <div class="car"></div>

  <div class="entrance">
    <div class="entrance-roof"></div>
    <div class="entrance-body">
      <div class="entrance-door"></div>
    </div>
  </div>
</div>

<script>
const loader = document.querySelector('.themepark-loader');
const cars = [...document.querySelectorAll('.car')];
const redLoop = document.querySelector('.loop-red');
const blueLoop = document.querySelector('.loop-blue');

const duration = parseFloat(getComputedStyle(document.documentElement)
  .getPropertyValue('--duration'));
const spacing = parseFloat(getComputedStyle(document.documentElement)
  .getPropertyValue('--spacing'));
const pause = 400; //pause between loops

function getLoopData(loop) {
  return {
    x: loop.offsetLeft + loop.offsetWidth / 2,
    y: loop.offsetTop + loop.offsetHeight / 2,
    r: loop.offsetWidth / 2 - 10
  };
}

const redData = getLoopData(redLoop);
const blueData = getLoopData(blueLoop);

let state = 'red'; 
let stateStart = performance.now();

function setCarsVisible(visible) {
  cars.forEach(car => {
    car.style.display = visible ? 'block' : 'none';
  });
}

function animateState(now) {
  const elapsed = now - stateStart;
  if (state === 'red') {
    setCarsVisible(true);
    const progress = Math.min(elapsed / duration, 1);
    const { x, y, r } = redData;
    cars.forEach((car, i) => {
      const angle = 2 * Math.PI * progress + (i - 1) * spacing + Math.PI / 2;
      car.style.left = x + r * Math.cos(angle) + 'px';
      car.style.top  = y + r * Math.sin(angle) + 'px';
    });
    if (elapsed >= duration) {
      state = 'pause1';
      stateStart = now;
    }
  } else if (state === 'pause1') {
    setCarsVisible(false);
    if (elapsed >= pause) {
      state = 'blue';
      stateStart = now;
    }
  } else if (state === 'blue') {
    setCarsVisible(true);
    const progress = Math.min(elapsed / duration, 1);
    const { x, y, r } = blueData;
    cars.forEach((car, i) => {
      const angle = 2 * Math.PI * progress + (i - 1) * spacing + Math.PI / 2;
      car.style.left = x + r * Math.cos(angle) + 'px';
      car.style.top  = y + r * Math.sin(angle) + 'px';
    });
    if (elapsed >= duration) {
      state = 'pause2';
      stateStart = now;
    }
  } else if (state === 'pause2') {
    setCarsVisible(false);
    if (elapsed >= pause) {
      state = 'red';
      stateStart = now;
    }
  }
  requestAnimationFrame(animateState);
}

requestAnimationFrame(animateState);
</script>

</body>
</html>